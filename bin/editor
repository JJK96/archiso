#!/bin/bash
kak -clear
TEMPDIR="/tmp/kak-temp"
args=()
open_command="open-in-new-window"
for arg in "$@"; do
    if [ "$arg" == "-t" ]; then
        in_terminal=true
        open_command="edit"
    else 
        args+=("$arg")
    fi
done 
# if there is standard input create a new file and open that
read -r -t 0.01 -d '' input
if [ -n "$input" ]; then
    mkdir -p $TEMPDIR
    temp=$(mktemp -p $TEMPDIR)
    echo "$input" > "$temp"
    args+=("$temp")
fi
if [ -z $KAK_SESSION ]; then
    KAK_SESSION="default"
    if ! kak -l | grep default > /dev/null 2>&1; then
        kak -s $KAK_SESSION -d
    fi
fi
if [ $KAK_CLIENT ] && [ ! $in_terminal ]; then
    command="x11-focus $KAK_CLIENT;"
fi
if [ ${#args[@]} == 0 ]; then
   if [ -z $in_terminal ]; then
        command="$command new "
   fi
   command="$command edit -scratch *scratch*;"
fi 
for file in "${args[@]}"; do
    command="$command $open_command $(realpath "$file");"
done
if [ $in_terminal ]; then
    kak -c $KAK_SESSION -e "$command"
else
    echo "eval '$command'" | kak -p $KAK_SESSION
fi
